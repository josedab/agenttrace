name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  GO_VERSION: "1.21"
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

jobs:
  # Changelog Check (for PRs)
  changelog-check:
    name: Changelog Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for skip-changelog label
        id: check-label
        uses: actions/github-script@v7
        with:
          script: |
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const skipChangelog = labels.some(label =>
              ['skip-changelog', 'chore', 'ci', 'internal'].includes(label.name)
            );
            core.setOutput('skip', skipChangelog);
            console.log(`Skip changelog: ${skipChangelog}`);

      - name: Check CHANGELOG.md updated
        if: steps.check-label.outputs.skip != 'true'
        run: |
          # Check if CHANGELOG.md was modified in this PR
          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md" || {
            echo "::warning::CHANGELOG.md was not updated."
            echo ""
            echo "If this PR should be included in the changelog, please update CHANGELOG.md."
            echo "Add your changes under the [Unreleased] section."
            echo ""
            echo "If this PR should NOT be in the changelog, add one of these labels:"
            echo "  - skip-changelog"
            echo "  - chore"
            echo "  - ci"
            echo "  - internal"
            echo ""
            echo "See docs/RELEASE_PROCESS.md for more information."
          }

      - name: Validate CHANGELOG format
        run: |
          # Check that CHANGELOG.md has required sections
          if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
            echo "::error::CHANGELOG.md must have an [Unreleased] section"
            exit 1
          fi

          # Check for valid Keep a Changelog format
          if ! head -5 CHANGELOG.md | grep -q "Keep a Changelog"; then
            echo "::warning::CHANGELOG.md should reference Keep a Changelog format"
          fi

          echo "CHANGELOG.md format is valid"

  # Go Backend Tests
  go-backend:
    name: Go Backend
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: agenttrace
          POSTGRES_PASSWORD: agenttrace
          POSTGRES_DB: agenttrace_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('api/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        working-directory: api
        run: go mod download

      - name: Run linter
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          working-directory: api
          args: --timeout=5m

      - name: Run tests
        working-directory: api
        run: go test -v -race -coverprofile=coverage.out ./...
        env:
          DATABASE_URL: postgres://agenttrace:agenttrace@localhost:5432/agenttrace_test?sslmode=disable
          REDIS_URL: redis://localhost:6379

      - name: Check coverage threshold
        working-directory: api
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COVERAGE}%"
          THRESHOLD=60
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::error::Coverage ${COVERAGE}% is below ${THRESHOLD}% threshold"
            exit 1
          fi
          echo "::notice::Coverage ${COVERAGE}% meets ${THRESHOLD}% threshold"

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: api/coverage.out
          flags: go-backend
          fail_ci_if_error: false

  # Next.js Frontend Tests
  nextjs-frontend:
    name: Next.js Frontend
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Run linter
        working-directory: web
        run: npm run lint

      - name: Run type check
        working-directory: web
        run: npm run typecheck

      - name: Run tests
        working-directory: web
        run: npm test -- --coverage

      - name: Build
        working-directory: web
        run: npm run build

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: web/coverage/lcov.info
          flags: nextjs-frontend
          fail_ci_if_error: false

  # Python SDK Tests
  python-sdk:
    name: Python SDK
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        working-directory: sdk/python
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run linter
        working-directory: sdk/python
        run: ruff check .

      - name: Run type check
        working-directory: sdk/python
        run: mypy agenttrace --ignore-missing-imports

      - name: Run tests
        working-directory: sdk/python
        run: pytest -v --cov=agenttrace --cov-report=xml --cov-fail-under=60

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: sdk/python/coverage.xml
          flags: python-sdk
          fail_ci_if_error: false

  # TypeScript SDK Tests
  typescript-sdk:
    name: TypeScript SDK
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: sdk/typescript/package-lock.json

      - name: Install dependencies
        working-directory: sdk/typescript
        run: npm ci

      - name: Run linter
        working-directory: sdk/typescript
        run: npm run lint

      - name: Run type check
        working-directory: sdk/typescript
        run: npm run typecheck

      - name: Run tests
        working-directory: sdk/typescript
        run: npm test -- --coverage

      - name: Build
        working-directory: sdk/typescript
        run: npm run build

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: sdk/typescript/coverage/lcov.info
          flags: typescript-sdk
          fail_ci_if_error: false

  # Go SDK Tests
  go-sdk:
    name: Go SDK
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-sdk-${{ hashFiles('sdk/go/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-sdk-

      - name: Run tests
        working-directory: sdk/go
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Check coverage threshold
        working-directory: sdk/go
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COVERAGE}%"
          THRESHOLD=60
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::error::Coverage ${COVERAGE}% is below ${THRESHOLD}% threshold"
            exit 1
          fi
          echo "::notice::Coverage ${COVERAGE}% meets ${THRESHOLD}% threshold"

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: sdk/go/coverage.out
          flags: go-sdk
          fail_ci_if_error: false

  # CLI Tests
  cli:
    name: CLI
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-cli-${{ hashFiles('sdk/cli/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-cli-

      - name: Build CLI
        working-directory: sdk/cli
        run: go build -o agenttrace .

      - name: Run tests
        working-directory: sdk/cli
        run: go test -v -race ./...

  # Docker Build
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [go-backend, nextjs-frontend]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API image
        uses: docker/build-push-action@v5
        with:
          context: ./api
          push: false
          tags: agenttrace/api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Web image
        uses: docker/build-push-action@v5
        with:
          context: ./web
          push: false
          tags: agenttrace/web:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # End-to-End Tests
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [go-backend]
    # Only run E2E tests on main branch or PRs to main
    if: github.event_name == 'push' || github.base_ref == 'main'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: agenttrace
          POSTGRES_PASSWORD: agenttrace_e2e
          POSTGRES_DB: agenttrace_e2e
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      clickhouse:
        image: clickhouse/clickhouse-server:24.2
        env:
          CLICKHOUSE_USER: agenttrace
          CLICKHOUSE_PASSWORD: agenttrace_e2e
          CLICKHOUSE_DB: agenttrace
          CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
        ports:
          - 8123:8123
          - 9000:9000
        options: >-
          --health-cmd "clickhouse-client --query 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-e2e-${{ hashFiles('api/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-e2e-
            ${{ runner.os }}-go-

      - name: Install dependencies
        working-directory: api
        run: go mod download

      - name: Build API server
        working-directory: api
        run: go build -o ./bin/server ./cmd/server

      - name: Run database migrations
        working-directory: api
        run: |
          # Run migrations using the built-in migration tool
          ./bin/server migrate up
        env:
          DATABASE_URL: postgres://agenttrace:agenttrace_e2e@localhost:5432/agenttrace_e2e?sslmode=disable
          CLICKHOUSE_DSN: clickhouse://agenttrace:agenttrace_e2e@localhost:9000/agenttrace
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: e2e-test-jwt-secret-key-at-least-32-chars
          ENCRYPTION_KEY: e2e-test-encryption-key-32-bytes!

      - name: Start API server
        working-directory: api
        run: |
          ./bin/server &
          echo $! > /tmp/server.pid
          # Wait for server to start
          for i in {1..30}; do
            if curl -s http://localhost:8080/health | grep -q "ok"; then
              echo "Server is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Server failed to start"
              cat /tmp/server.log 2>/dev/null || true
              exit 1
            fi
            sleep 2
          done
        env:
          DATABASE_URL: postgres://agenttrace:agenttrace_e2e@localhost:5432/agenttrace_e2e?sslmode=disable
          CLICKHOUSE_DSN: clickhouse://agenttrace:agenttrace_e2e@localhost:9000/agenttrace
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: e2e-test-jwt-secret-key-at-least-32-chars
          ENCRYPTION_KEY: e2e-test-encryption-key-32-bytes!
          API_HOST: 0.0.0.0
          API_PORT: 8080
          LOG_LEVEL: info
          E2E_TEST_MODE: "true"

      - name: Create test API key
        id: create-key
        run: |
          # Create test organization, project, and API key via psql
          PGPASSWORD=agenttrace_e2e psql -h localhost -U agenttrace -d agenttrace_e2e <<'EOF'
          -- Create test organization
          INSERT INTO organizations (id, name, slug, created_at, updated_at)
          VALUES ('00000000-0000-0000-0000-000000000001', 'E2E Test Org', 'e2e-test-org', NOW(), NOW())
          ON CONFLICT (id) DO NOTHING;

          -- Create test project
          INSERT INTO projects (id, organization_id, name, slug, created_at, updated_at)
          VALUES ('00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000001', 'E2E Test Project', 'e2e-test-project', NOW(), NOW())
          ON CONFLICT (id) DO NOTHING;

          -- Create test API key
          -- public_key is used for lookup, secret_key_hash for validation (but ValidateAPIKeyPublicOnly skips hash check)
          -- secret_key_preview is the last 4 chars of the secret key
          INSERT INTO api_keys (id, project_id, public_key, secret_key_hash, secret_key_preview, name, scopes, created_at, updated_at)
          VALUES (
            '00000000-0000-0000-0000-000000000003',
            '00000000-0000-0000-0000-000000000002',
            'pk-e2e0000000000000000000000000test',
            '$2a$10$placeholder.hash.not.used.for.public.key.only.auth',
            'test',
            'E2E Test Key',
            ARRAY['traces:write', 'traces:read', 'scores:write', 'scores:read'],
            NOW(),
            NOW()
          )
          ON CONFLICT (id) DO NOTHING;
          EOF

          # The API key only needs the public key for ValidateAPIKeyPublicOnly
          echo "AGENTTRACE_API_KEY=pk-e2e0000000000000000000000000test" >> $GITHUB_ENV

      - name: Run E2E tests
        working-directory: api
        run: go test -v -tags=e2e ./tests/e2e/...
        env:
          AGENTTRACE_API_URL: http://localhost:8080
          AGENTTRACE_API_KEY: ${{ env.AGENTTRACE_API_KEY }}

      - name: Stop API server
        if: always()
        run: |
          if [ -f /tmp/server.pid ]; then
            kill $(cat /tmp/server.pid) 2>/dev/null || true
          fi

      - name: Upload E2E test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs
          path: |
            /tmp/server.log
          retention-days: 7
