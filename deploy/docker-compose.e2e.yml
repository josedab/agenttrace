version: "3.9"

# E2E Testing Configuration
# Uses local builds for API and runs against test infrastructure

services:
  # PostgreSQL - Metadata storage
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: agenttrace
      POSTGRES_PASSWORD: agenttrace_e2e
      POSTGRES_DB: agenttrace_e2e
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U agenttrace"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - e2e

  # ClickHouse - Trace storage
  clickhouse:
    image: clickhouse/clickhouse-server:24.2
    environment:
      CLICKHOUSE_USER: agenttrace
      CLICKHOUSE_PASSWORD: agenttrace_e2e
      CLICKHOUSE_DB: agenttrace
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ports:
      - "8123:8123"
      - "9000:9000"
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - e2e

  # Redis - Queue and caching
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - e2e

  # MinIO - Object storage
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: agenttrace
      MINIO_ROOT_PASSWORD: agenttrace_e2e
    ports:
      - "9001:9001"
      - "9002:9000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - e2e

  # API Server - Built from local source
  api:
    build:
      context: ../api
      dockerfile: Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://agenttrace:agenttrace_e2e@postgres:5432/agenttrace_e2e?sslmode=disable
      CLICKHOUSE_DSN: clickhouse://agenttrace:agenttrace_e2e@clickhouse:9000/agenttrace
      REDIS_URL: redis://redis:6379
      JWT_SECRET: e2e-test-jwt-secret-key-at-least-32-chars
      ENCRYPTION_KEY: e2e-test-encryption-key-32-bytes!
      API_HOST: 0.0.0.0
      API_PORT: 8080
      LOG_LEVEL: info
      # Auto-migrate database on startup
      AUTO_MIGRATE: "true"
      # Create default test project and API key
      E2E_TEST_MODE: "true"
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - e2e

  # Background Worker
  worker:
    build:
      context: ../api
      dockerfile: Dockerfile
    command: ["/app/worker"]
    depends_on:
      api:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://agenttrace:agenttrace_e2e@postgres:5432/agenttrace_e2e?sslmode=disable
      CLICKHOUSE_DSN: clickhouse://agenttrace:agenttrace_e2e@clickhouse:9000/agenttrace
      REDIS_URL: redis://redis:6379
    networks:
      - e2e

networks:
  e2e:
    driver: bridge
